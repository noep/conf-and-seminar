Kakao If 2019
=============
https://if.kakao.com/program

##### 10시
- 키노트
---
##### 11시
- R5, 서버 성능테스트 Tip - 사례를 통해 얻은 교훈들

- ngle 테스트 / 품질 검증 전문 회사
- 카카오게임즈 게임 대부분에 대한 성능 테스트
- 아젠다 :  개요 / 진행사례 교훈 / 더 좋은 테스트를 위해 / 정리

- 개요
    - 진행사례
        - 초급 : 이용자의 다양한 액션 누락
            - 다양한 이용자의 흐름 세분화 및 API별 시나리오 명세 작성
            - 일단 시나리오를 잘 작성한다, 시간정보도 입력
                - 스크립트 상에 sleep도 집어넣어 준다
        - 초급 : 최종 시스템(=라이브 시스템)의 성능 테스트 누락
            - 성능 테스트 망과 실제 부하를 받는 망의 환경이 달랐음
            - 쉬운 일이 아니네, 성능테스트 프로세스를 개선해서 해결 
        - 초급 : 예외 상황에 대한 테스트 누락
            - 로그 서버 죽음 -> API 서버로 장애 전파 -> API서버도 죽음 (당연히...)
            - msa 안해봤나? 
            - 모든 구성 서버들에 대해 예외 상황 테스트 진행
            - 서버 여러대 중 한대를 죽이고 부하 테스트 하는 등..
             - 결론 : autoscaling, failover 테스트도 진행해야 한다.
         - 중급 : Connection을 유지하는 100만 이용자
            - 100만명이 30분동안 커넥션 유지
            - Aws LB(NLB) 넣어서 로드밸런싱 테스트
                - 70만 vuser 인입시 error -> 설정 변경 후 100만 통과 -> clear -> 다음날 다시 하니 안됨 -> 문의 : Pre-Warm-Up 필요함? 답 ㄴㄴ
                - 이는 매일 첫 테스트시에만 발생함 (이상함) 2주 내내 -> AWS 전달 -> Pre-Warm Up 하세요
                - 가이드가 거짓말을 침 -> 참고만 합시다.
        - 중급 : API 검증 실패
            - REST API 테스트하는거 -> 너무 테스트가 잘됨 -> 이상하다? -> 서버가 Mock서버 (헐)
            - 커뮤니케이션 부족으로 발생, 서버 동작 검증시 200만 검증했기 때문
            - -> 데이터 검증 프로세스도 추가 (스크립트에 반영 가능하지 않을까)
        - 고급 : Server Push로 액션이 시작되는 서비스
            - server Push로 액션이 시작되는 웹소켓 서버
            - 봇 클라이언트로 테스트 진행을 했으나 -> 개발자 리소스가 지속적으로 들어감
            - ngrinder의 경우 단일 스레드를 이용한 테스트만 가능함
            - 네티로 공용 I/O스레드를 두고 소켓 열기
        - 고급 : 120개의 봇을 수동으로 실행해야 하는 경우
            - 봇 클라이언트 1개당 500 vuser / 60000 동접 목표 => 120개의 봇 클라이언트
            - ngrinder controller -> agent 에 배치 스크립트 구동하도록 함
            - agent가 봇 클라이언트를 띄울 수 있도록
            - 그러면 agent 120대 띄운건가??
    - 업그레이드 고민
        - 시스템의 기본 성능에 대한 기준을 만들 수 있지 않을까?
            - ex) C4.xlarge는 기본적으로 몇 TPS는 나옵니다.
            - 앱과 아키텍처 구조에 따라 다 다를텐데 이게 가능해?
            - 일단 분류는 열심히 (테스트 결과를 통계화)
        - 테스트 가능 환경의 확장
            - 현재 : webServer, http, ws
            - 앞으로 : webSErver, app, http, ws, tcp 테스트도 가능하도록
    - QNA
        - ngrinder를 쓰는 이유
            - 주로 http 테스트 이용
            - python으로 사용했는데 -> jython쓸 수 있어서
            - 스크립트를 이용한 자유로운 테스트 시나리오 작성
        - aws 과금은?
            - 1대 -> 2대(부하분산) -> 본격 테스트
            - 다수의 인스턴스 -> 스팟 형태로 사용
        - netty서버 자체에도 부하가 갈텐데? 라이브 환경과 달라지지 않는가
            - ??
        - ngrinder 모니터 기능 취약?
            - 개발사에서 제공하는 zabbix 등을 이용해 모니터링
            
            ![image1](./pics/11-1.jpeg)
            ![image1](./pics/11-2.jpeg)
            ![image1](./pics/11-3.jpeg)
            ![image1](./pics/11-4.jpeg)

---
##### 12시
- R3, 초당옥수수의 취소를 막아라! : 수만 건의 주문을 1초내에 처리하는 기술

- 카카오커머스
- 초당옥수수의 비밀 / 레거시 문제점 / 미션 / 액터,비동기 워커 / 배포없이 빠르게 롤백하는 전략 / 판매자 인터뷰

- 초당옥수수의 비밀
    - 옥수수 / 배송 지연
    - 광고
    - 수확 후 바로 배송 / 배송 지연 / 기상(비오면 말려서 수확) 상황에 영향을 받음
    - BL 소개
- 레거시
    - 배송지연 안내 TMS 배치
        - jenkins로 배치 처리해서 발송 (1시간 간격)
        - 주문 몰림 대처가어려움
    - 비즈니스 로직이 복잡
    - 처리 속도 문제
        - 1요청-1스레드, (서블릿 기반이라는 건가?)
- 미션
    - 실시간 TMS 발송
        - 배치 처리 -> 비동기 워커구성 후 처리 (큐잉)
    - 코드 리팩토링
        - 기존 : 요구사항이 계속 늘면서 복잡도 증가, 스파게티화
        - 정리함 -> 구조 단계의 명확화
    - 처리속도 개선
        - 검증 -> 비즈니스 처리 -> TMS 발송
        - 병목 발생 지점 확인 -> 비즈니스 처리
        - 변경 후 : 검증 -> 비즈니스 처리 비동기 워커 -> TMS발송 비동기 워커
        - 변경 후 : 검증 -> 비즈니스 처리 비동기 워커(큐, 컨슈머) -> TMS발송 비동기 워커(큐, 컨슈머)
            - 각각의 워커에서의 메세지는 큐를 통해 전달
- 액터가 된 비동기 워커
    - 분산 처리
        - 큐, 컨슈머 구조
        - 컨슈머 하나가 atomic한 단위로 동작하게 만듦 -> 이후 노드 증설
        - Spring amqp 확장으로 구현(SimpleRabbitListenerContainerFactory)
    - 자동 재처리 및 실패 감지
        - 네트웍 장애 등 일시 장애 상황들이 발생하는 경우
        - 배송은 성격상 서드파티 api 연동이 많음
        - 재처리용 큐를 하나 더 둠 / 실패 메세지 받는 큐를 둠
        - 배치 잡으로 실패 메세지를 주기적으로 db에 저장 / 개발자에게 알림 (이후 개별처리)
    - rabbitmq를 쓰는 이유
        - message header / queue 속성을 잘 쓰기 위해
        - 클러스터 -> 고기용성
    - 구현 (RabbitMQ)
        - 발표자료를 보는 게 나을듯
    - 결론 : 액터 모델 구현
        - 각 비즈니스의 처리 단위가 액터가 되고, 액터는 수평확장이 가능
        - 성능이 많이 좋아졌는가?
            - 그렇다
    - 더 해야할 것
        - 액터 메세지 추적
        - 이거 쉽지 않음 ㅠ
        
- 배포 없이 빠르게 롤백하는 전략
    - zookeeper 이용해서 app에 캐싱 (그 감지하는 코드 집어넣어서)
    - 코드 레벨에서 on/OFF 스위치 이용
    - 그러면 기존 코드 + 새로운 코드가 한 jar에? -> 맞음
- QNA
    - 
    
    

             
        
        
        
    
 










---
##### 14시
- R3, Practical Microservices in gRPC Go feat. GraphQL, Kafka(서포터즈 기사 개발기)
---
##### 15시
- R2, Airflow를 활용하여 아름다운 데이터 파이프라인 구성하기
---
##### 16시
- R2, 광고 데이터 처리 시스템 소개
---





















